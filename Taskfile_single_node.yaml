version: 3

tasks:

  deploy:
    desc: Deploy k3s single-node cluster
    cmds:
      - echo "Creating k3s single-node cluster"
      - task: create-single-node-cluster
      - export KUBECONFIG="$(k3d kubeconfig write {{.KUBE_CLUSTER}})"
      - echo "Creating namespace {{.KUBE_NAMESPACE}}"
      - kubectl create namespace {{.KUBE_NAMESPACE}}
      - task dashboard:deploy
      - echo "Done"

  create-single-node-cluster:
    internal: true
    cmds:
      - |
        k3d cluster create {{.KUBE_CLUSTER}} \
          --api-port 6550 \
          --port "{{.HOST_HTTP_PORT}}:80@loadbalancer" \
          --agents 2
